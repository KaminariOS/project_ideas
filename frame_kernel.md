[Frame kernel](https://www.bilibili.com/video/BV1fhnbzjEBP)

# ⭐ 总览：Asterinas（星绽）的核心思想

星战是一个 **Rust 实现、与 Linux ABI 兼容、但更安全可靠的通用 OS 内核**。
它不是“再做一个 Linux 克隆”，而是：

> **使用 Rust 的思维方式重新想象 OS 内核架构本身。**

核心贡献：

* 提出 **Frame Kernel（框内核）架构**
* 利用 Rust 的安全模型，将内核 unsafe TCB 压缩到极小
* 自动化地确保 TCB 内没有内存安全问题（Kernel Miri）
* 实现大量 Linux 功能与系统调用，性能与 Linux 打得有来有回
* 获得顶会论文（ATC、ATC、SOSP）

---

# 1️⃣ 为什么要重新设计 OS 内核？

## Rust 的潜力

Rust 最大价值并不是“重新写一份 Linux”，而是：

* 提供内存安全
* 影响开发者思考方式（Sapir-Whorf Hypothesis）
* 用“Rust-native 思维”重新设计系统架构

传统 OS 的最大问题是：

* **几乎 70% 的漏洞**来自内存安全问题
* 不管是 Monolithic kernel 还是 Microkernel，都无法同时满足

  * 性能
  * 安全
  * 可维护性

Rust 提供了机会让你同时得到三件事。

---

# 2️⃣ 两种传统内核架构的问题

## ① Monolithic Kernel（Linux）

* 所有代码在特权态
* 性能最好
* 但任何一行 bug 都可能破坏整个内核

## ② Microkernel

* 将大部分服务放用户态
* 安全性高
* 但 IPC 频繁 → **性能损耗大**

**几十年来没人找到兼具两者优势的架构。**

---

# 3️⃣ Frame Kernel（框内核）架构：核心概念

演讲的核心贡献就是这个架构。

## 目标

1. **内核完全无内存安全问题**
2. **TCB（可信计算基）最小化**

## 架构划分

内核被划分为两部分：

### 🔵 框架区（OSD）

* 含有所有 **unsafe Rust**
* 封装 CPU / 内存 / 外设 等敏感资源
* 提供安全抽象 API 给上层
* 这是 TCB，也是需要形式化验证的地方
* 约占代码的 **14%**

### ⚪ 非框架区（内核功能层）

* 约 85% 以上的代码
* **100% Safe Rust**
* 实现所有高层 OS 功能，如：

  * 文件系统
  * 调度器（可注入）
  * 内存管理的高层逻辑
  * 设备驱动
  * 系统调用实现

最终效果：

> 大部分内核开发者永远不需要写一行 unsafe。

---

# 4️⃣ 如何把 TCB 压到这么小？

星战实现了约 **11 万行代码**，其中：

* 只有 **2 个 crate** 含 unsafe
* 约 **14%** 属于 TCB（业内最小之一）

核心方法：

## ✔ 1. 将所有敏感 OS 资源进行“划分 → 抽象 → 封装”

包括：

* CPU
* 内存
* 外设

框架层保证：

> 到了 API 边界时，所有敏感资源都已经被转换为 safe 可用的抽象。

## ✔ 2. 复杂逻辑全部移出 TCB（例如调度器）

星战实现机制：

* 框架层提供 **Injection API**
* 上层可以“注入”调度器实现
* 调度器逻辑（非常复杂）完全在 TCB 外面

星战成功复刻 Linux 的所有调度类，且仍保持：

* 高性能
* 高复杂度支持
* 不影响内存安全

这是框内核架构的关键成果。

---

# 5️⃣ 星战的性能表现

在 SPEC、应用场景、Benchmarks 上与 Linux:

* **性能相当**
* 有些场景甚至更好

表明 frame kernel 架构没有带来性能损失。

---

# 6️⃣ 如何确保 TCB 内的 unsafe 没有问题？

星战组合使用：

## ✔ 1. 形式化验证（长期工作）

部分关键模块正在做 formal verification。

## ✔ 2. Kernel Miri —— 扩展 Miri 运行时检查内核

Miri 能检测：

* UB（未定义行为）
* Use-after-free
* 越界访问
* 数据竞争
* 并发边界问题

但原始 Miri 不理解：

* 无标准库环境
* 裸机硬件语义
* 中断、DMA、页表等架构级行为

星战团队构建了 **Kernel Miri**：

* 扩展了 Miri，让它了解 OS 与硬件语义
* 可以真正运行 X-Raynax 内核

结果：

* 单模块测试覆盖率 90%+
* 找到了人工审核很难发现的内存安全问题

这是确保安全性的关键工具。

---

# 7️⃣ 星战已经实现了什么？

## ✔ 与 Linux ABI 和 200+ 系统调用兼容

## ✔ 支持调度、内存管理、设备管理、文件系统等主要功能

## ✔ 与 Ant Group、北大、南科大合作

## ✔ 获得 ATC、SOSP 等顶会论文

## ✔ 完全开源

## ✔ 吸引国际社区贡献者加入

---

# 8️⃣ 星战未来方向

* 只做 **通用 OS 内核**（不做发行版）
* 允许各领域厂商基于星战构建自己的发行版
* 重点落地领域包括：

  * 数据中心 / 服务器
  * 车载
  * 机器人
  * 智能终端

---

# 🔚 总结：Rust 让 OS 内核第一次在三方面同时成功

星战证明：

> **功能丰富 + 高性能 + 完全内存安全
> 在 Rust 中可以同时做到。**

